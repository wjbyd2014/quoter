Function countStock(path,date);
Begin
    if not path then
        return '非法路径';
        
    板块文件列表 := iterDir(path);
    板块数量 := length(板块文件列表);
    
    if 板块数量 = 0 then
       return path + '中没有发现任何stock文件';

    for i := 0 to 板块数量 - 1 do
    begin
         procFile(板块文件列表[i], date);
    end
End;

Function procFile(fullFileName, date);
Begin
    fileName := str2array(fullFileName, '\\')[3];
    arr := str2array(fileName, '.');
    板块类型 := arr[0];
    板块名称 := arr[1];
    
    size := rdo2 filesize("", fullFileName);
    ret := rdo2 readFile(rwraw(), "", fullFileName, 0, size, data);
    if not ret then
        return;
        
    if not data then
       return;
       
    sumzf := 0.0;
    stocks := str2array(data, ";");
    股票数量 := length(stocks);
    for i := 0 to 股票数量 - 1 do
    begin
         if not stocks[i] then
             continue;
             
        stock := str2array(stocks[i], ":");
        stockName := stock[0];
        stockCode := stock[1];
        zf := getZF(date, stockCode);
        sumzf += zf;
    end
    
    return sumzf / (股票数量 - 1);
End;

// 计算股票涨幅
Function getZF(date, stockCode);
Begin
    SetSysParam(PN_Stock(), stockCode);
    EndT:=inttodate(date);
    return StockZf4(EndT);
End;

// 遍历目录中的stock文件
Function iterDir(dirPath);
Begin
    arrFiles := rdo2 filelist("", dirPath + '\\*.stock');
    result := array();
    for i := 0 to length(arrFiles) - 1 do
    begin
        result[i] := dirPath + '\\' + arrFiles[i]['FileName'];
    end
    return result;
End;
